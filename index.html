<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Expert-Amort PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<style>
.collapsible-content { max-height: 0; overflow: hidden; transition: max-height .4s ease; }
.font-numeric { font-family: ui-sans-serif, system-ui; font-weight: 700; }
</style>
</head>

<body class="bg-slate-50 p-6 text-slate-800">

<div class="max-w-6xl mx-auto">

<header class="mb-6 text-center border-b pb-4">
    <h1 class="text-4xl font-black">Expert-Amort <span class="text-emerald-600">PRO</span></h1>
    <p class="text-xs uppercase text-slate-500">Version de travail – moteur sécurisé</p>
</header>

<!-- ================= INVESTISSEMENT ================= -->
<section class="bg-white p-6 rounded-xl shadow mb-6">
    <h2 class="text-xl font-bold mb-4">1. Investissement</h2>

    <div class="grid md:grid-cols-2 gap-4">
        <div>
            <label>Date d’acquisition</label>
            <input id="dateAcq" type="date" class="w-full border p-2 rounded">
        </div>
        <div>
            <label>Date de mise en service</label>
            <input id="dateService" type="date" class="w-full border p-2 rounded">
        </div>

        <div>
            <label>Ouverture exercice</label>
            <input id="bilanDebut" type="date" class="w-full border p-2 rounded">
        </div>
        <div>
            <label>Clôture exercice</label>
            <input id="bilanFin" type="date" class="w-full border p-2 rounded">
        </div>

        <div>
            <label>Base HT</label>
            <input id="montantHT" type="number" class="w-full border p-2 rounded">
        </div>

        <div>
            <label>Valeur résiduelle</label>
            <input id="valeurResiduelle" type="number" value="0" class="w-full border p-2 rounded">
        </div>

        <div class="flex items-center gap-2">
            <input id="isVehicule" type="checkbox">
            <label>Véhicule de tourisme (TTC)</label>
        </div>
    </div>
</section>

<!-- ================= MÉTHODE ================= -->
<section class="bg-white p-6 rounded-xl shadow mb-6">
    <h2 class="text-xl font-bold mb-4">2. Méthode</h2>

    <div class="grid md:grid-cols-2 gap-4">
        <div>
            <label>Durée (années)</label>
            <input id="dureeEco" type="number" value="5" class="w-full border p-2 rounded">
        </div>

        <div>
            <label>Mode fiscal</label>
            <select id="typeFisc" class="w-full border p-2 rounded">
                <option value="lineaire">Linéaire</option>
                <option value="degressif">Dégressif</option>
            </select>
        </div>
    </div>
</section>

<div class="text-center mt-6">
    <button onclick="genererTableau()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-10 py-4 rounded-xl text-xl font-black">
        Calculer
    </button>
</div>

<div id="zoneTableau" class="mt-8 hidden">
    <h3 class="text-xl font-bold mb-4">Plan d’amortissement</h3>
    <table id="tableNormal" class="w-full border text-sm"></table>
</div>

<script>
// ------------------ OUTILS ------------------
const € = v => new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(v);
const $ = id => document.getElementById(id);

function jours(d1, d2) { return Math.floor((d2 - d1) / 86400000) + 1; }

// Auto dates
document.getElementById("dateAcq").addEventListener("change", e => {
    const d = new Date(e.target.value);
    if (!isNaN(d)) {
        $("dateService").value = e.target.value;
        $("bilanDebut").value = `${d.getFullYear()}-01-01`;
        $("bilanFin").value = `${d.getFullYear()}-12-31`;
    }
});

// ------------------ CALCUL ------------------
function genererTableau() {

    const baseHT = +$("montantHT").value || 0;
    const vr = +$("valeurResiduelle").value || 0;
    const isVeh = $("isVehicule").checked;

    const base = (isVeh ? baseHT * 1.2 : baseHT) - vr;

    const dAcq = new Date($("dateAcq").value);
    const dDeb = new Date($("bilanDebut").value);
    const dFin = new Date($("bilanFin").value);

    const duree = parseInt($("dureeEco").value);

    let cumul = 0;
    let lignes = [];

    for (let i = 0; i < duree; i++) {

        let debut = new Date(dDeb);
        debut.setFullYear(dDeb.getFullYear() + i);

        let fin = new Date(dFin);
        fin.setFullYear(dFin.getFullYear() + i);

        let debutCalc = (i === 0 ? dAcq : debut);
        let joursAmort = jours(debutCalc, fin);

        let dot = (base / duree) * (joursAmort / 365);
        dot = Math.min(dot, base - cumul);

        cumul += dot;

        lignes.push({
            annee: debut.getFullYear(),
            dot,
            cumul,
            vnc: base - cumul
        });

        if (cumul >= base) break;
    }

    let html = `<thead class="bg-slate-800 text-white">
        <tr><th>Année</th><th>Dotation</th><th>Amort. cumulé</th><th>VNC</th></tr>
    </thead><tbody>`;

    lignes.forEach(l => {
        html += `<tr>
            <td>${l.annee}</td>
            <td>${€(l.dot)}</td>
            <td>${€(l.cumul)}</td>
            <td>${€(l.vnc)}</td>
        </tr>`;
    });

    document.getElementById("tableNormal").innerHTML = html + "</tbody>";
    document.getElementById("zoneTableau").classList.remove("hidden");
}
</script>

</body>
</html>
